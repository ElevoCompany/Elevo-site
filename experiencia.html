<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELEVO - A Conexão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Georgia&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Georgia', serif;
            overflow: hidden;
            background-color: #000000;
            color: #ffffff;
        }
        .font-title {
            font-family: 'Playfair Display', serif;
        }
        #interactionCanvas {
            background-color: #000000;
            cursor: pointer;
        }
        .modal-bg {
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen m-0 p-0">

    <div id="app-container" class="w-full h-full">
        <canvas id="interactionCanvas"></canvas>
    </div>

    <!-- Modal para Multiplayer -->
    <div id="sessionModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg">
        <div class="bg-white/10 border border-white/20 text-white rounded-2xl shadow-2xl p-8 max-w-sm w-full">
            <h2 class="font-title text-3xl font-bold text-center mb-4">Entrar em uma Sessão</h2>
            <div class="space-y-4">
                <input type="text" id="sessionIdInput" placeholder="ID da Sessão (ou deixe em branco)" class="w-full px-4 py-3 bg-black/30 border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-white/50 text-center">
                <button id="joinSessionBtn" class="w-full bg-blue-500 font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-300 shadow-lg">
                    Conectar
                </button>
            </div>
            <p id="authStatus" class="text-center mt-2 text-sm text-yellow-300 h-5"></p>
            <p id="userIdDisplay" class="text-center mt-2 text-xs text-white/50 break-all"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Configurações & Variáveis Globais ---
        const canvas = document.getElementById('interactionCanvas');
        const ctx = canvas.getContext('2d');
        const sessionModal = document.getElementById('sessionModal');
        const sessionIdInput = document.getElementById('sessionIdInput');
        const joinSessionBtn = document.getElementById('joinSessionBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const authStatus = document.getElementById('authStatus');
        
        let appState = 'intro_start'; 
        let pads = [];
        let stars = [];
        let myActivePad = null;
        let mousePos = { x: canvas.width / 2, y: canvas.height / 2 };
        let introClickCount = 0;
        let activePads = {}; 

        // --- As Tábuas da Lei (Sua Chave Pessoal do Firebase) ---
        const firebaseConfig = {
          apiKey: "AIzaSyD2lmUy9EctSxqZKpcVYopU5yJNSD1xWbQ",
          authDomain: "elevo-company.firebaseapp.com",
          projectId: "elevo-company",
          storageBucket: "elevo-company.firebasestorage.app",
          messagingSenderId: "202606299572",
          appId: "1:202606299572:web:1c3681306f469d305f0ae1",
          measurementId: "G-NP7W4BZX4T"
        };
        
        const appId = 'elevo-company-app';
        let db, auth, userId, currentSessionId;
        let unsubscribeFromPads = () => {};

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                if(userIdDisplay) userIdDisplay.textContent = `Seu ID de Conexão: ${userId.slice(0,12)}...`;
                if(authStatus) authStatus.textContent = 'Conectado. Pronto para entrar.';
            } else {
                if(authStatus) authStatus.textContent = 'Autenticando...';
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Erro na autenticação:", error);
                    if(authStatus) authStatus.textContent = 'Erro de conexão. Tente recarregar.';
                }
            }
        });
        
        const reverb = new Tone.Reverb(3).toDestination();
        const mainSynth = new Tone.PolySynth(Tone.FMSynth, {
            harmonicity: 3, modulationIndex: 10,
            envelope: { attack: 0.01, decay: 0.4, sustain: 0.1, release: 1.4 },
            volume: -10
        }).connect(reverb);
        const feedbackSound = new Tone.MembraneSynth({
            pitchDecay: 0.01, octaves: 10, oscillator: { type: 'sine' },
            envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.4, attackCurve: 'exponential' },
            volume: -25
        }).toDestination();

        window.onload = () => {
            setupCanvas();
            requestAnimationFrame(mainLoop);
        };
        
        function setupCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            stars = [];
            for (let i = 0; i < 250; i++) {
                stars.push({
                    x: Math.random() * canvas.width, y: Math.random() * canvas.height,
                    z: Math.random(), radius: Math.random() * 1.5,
                    alpha: 0.5 + Math.random() * 0.5, pulseSpeed: Math.random() * 0.02
                });
            }
            window.addEventListener('resize', setupCanvas);
            canvas.addEventListener('mousemove', (e) => { mousePos.x = e.clientX; mousePos.y = e.clientY; });
        }

        function setupPads() {
            if(pads.length > 0) return;
            const numPads = 5;
            const center = { x: canvas.width / 2, y: canvas.height / 2 };
            const radius = Math.min(canvas.width, canvas.height) * 0.25;
            const padRadius = Math.min(canvas.width, canvas.height) * 0.05;
            const notes = ['C4', 'E4', 'G4', 'B4', 'C5'];
            const colors = ['#f4d35e', '#f1faee', '#a8dadc', '#457b9d', '#e63946'];
            for (let i = 0; i < numPads; i++) {
                const angle = (i / numPads) * Math.PI * 2 - (Math.PI / 2);
                pads.push({
                    id: `pad-${i}`, x: center.x + Math.cos(angle) * radius, y: center.y + Math.sin(angle) * radius,
                    radius: padRadius, baseRadius: padRadius, note: notes[i], color: colors[i], isActive: false
                });
            }
        }

        function mainLoop(timestamp) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawStars(timestamp);
            switch(appState) {
                case 'intro_start': drawIntroText("Clique para iniciar", timestamp); break;
                case 'intro_respire': drawIntroText("Respire", timestamp); break;
                case 'intro_conecte': drawIntroText("Conecte-se", timestamp); break;
                case 'intro_elevo': drawIntroText("ELEVO", timestamp, true); break;
                case 'main':
                    if (pads.length === 0) setupPads();
                    drawPads(timestamp);
                    break;
            }
            requestAnimationFrame(mainLoop);
        }

        function drawStars(timestamp) {
            const parallaxX = (mousePos.x - canvas.width / 2) * 0.005;
            const parallaxY = (mousePos.y - canvas.height / 2) * 0.005;
            stars.forEach(star => {
                ctx.beginPath();
                const pulse = Math.sin(timestamp * 0.001 + star.pulseSpeed * 100) * 0.4 + 0.6;
                ctx.globalAlpha = star.alpha * pulse;
                ctx.fillStyle = '#FFFFFF';
                ctx.arc(star.x + parallaxX * star.z, star.y + parallaxY * star.z, star.radius, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1.0;
        }

        function drawIntroText(text, timestamp, isTitle = false) {
            const pulse = 1 + 0.03 * Math.sin(timestamp * 0.001);
            ctx.save();
            ctx.globalAlpha = 1;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = `${isTitle ? 60*pulse : 40*pulse}px "${isTitle ? 'Playfair Display' : 'Georgia'}", serif`;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.shadowColor = 'rgba(255, 255, 255, 0.7)';
            ctx.shadowBlur = 15;
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            ctx.restore();
        }

        function drawPads(timestamp) {
            pads.forEach(pad => {
                const isActive = activePads[pad.id];
                const pulse = 1 + 0.05 * Math.sin(timestamp * 0.002 + pad.x);
                pad.radius = pad.baseRadius * (isActive ? 1.1 : pulse);
                ctx.beginPath();
                ctx.arc(pad.x, pad.y, pad.radius, 0, Math.PI * 2);
                ctx.fillStyle = pad.color;
                ctx.globalAlpha = isActive ? 1.0 : 0.7;
                ctx.fill();
                if(isActive){
                    ctx.shadowColor = pad.color;
                    ctx.shadowBlur = 30;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            });
            ctx.globalAlpha = 1.0;
        }
        
        function handleGlobalClick(evt){
             Tone.start(); 
             feedbackSound.triggerAttack("C1", Tone.now());
             introClickCount++;
             if (introClickCount > 3) {
                 sessionModal.classList.remove('hidden');
                 canvas.removeEventListener('click', handleGlobalClick);
             } else {
                appState = ['intro_start', 'intro_respire', 'intro_conecte', 'intro_elevo'][introClickCount];
             }
        }
        canvas.addEventListener('click', handleGlobalClick);

        function setupInteractionListeners() {
            canvas.addEventListener('mousedown', handleInteractionStart);
            canvas.addEventListener('mouseup', handleInteractionEnd);
            canvas.addEventListener('touchstart', handleInteractionStart, { passive: false });
            canvas.addEventListener('touchend', handleInteractionEnd);
        }

        async function handleInteractionStart(evt) {
            evt.preventDefault();
            if(myActivePad || !userId) return; 
            const pos = getEventPos(evt);
            for (const pad of pads) {
                if (Math.hypot(pos.x - pad.x, pos.y - pad.y) < pad.radius) {
                    myActivePad = pad;
                    mainSynth.triggerAttack(pad.note, Tone.now());
                    feedbackSound.triggerAttack("C2", Tone.now() + 0.01);
                    const padRef = doc(db, `artifacts/${appId}/public/data/elevo-company/${currentSessionId}/pads/${myActivePad.id}`);
                    await setDoc(padRef, { userId: userId });
                    break;
                }
            }
        }

        async function handleInteractionEnd(evt) {
            if (!myActivePad) return;
            evt.preventDefault();
            mainSynth.triggerRelease(myActivePad.note, Tone.now());
            const padRef = doc(db, `artifacts/${appId}/public/data/elevo-company/${currentSessionId}/pads/${myActivePad.id}`);
            await deleteDoc(padRef);
            myActivePad = null;
        }

        function getEventPos(evt) {
            const rect = canvas.getBoundingClientRect();
            const clientX = evt.clientX ?? evt.changedTouches[0].clientX;
            const clientY = evt.clientY ?? evt.changedTouches[0].clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        joinSessionBtn.addEventListener('click', () => {
            if (!userId) {
                authStatus.textContent = "Aguardando autenticação...";
                return;
            }
            currentSessionId = sessionIdInput.value.trim() || `elevo-${crypto.randomUUID().slice(0, 6)}`;
            sessionModal.classList.add('hidden');
            appState = 'main';
            setupInteractionListeners();
            joinSession();
        });

        async function joinSession() {
            const padCollectionRef = collection(db, `artifacts/${appId}/public/data/elevo-company/${currentSessionId}/pads`);
            unsubscribeFromPads = onSnapshot(padCollectionRef, (snapshot) => {
                const remotePads = {};
                snapshot.forEach(doc => { remotePads[doc.id] = doc.data().userId; });
                activePads = remotePads;
                
                const remoteActiveNotes = Object.keys(remotePads).map(padId => pads.find(p => p.id === padId)?.note).filter(Boolean);
                const localNote = myActivePad ? myActivePad.note : null;
                if(localNote && !remoteActiveNotes.includes(localNote)){
                    remoteActiveNotes.push(localNote);
                }

                const currentlyPlaying = mainSynth.activeVoices.map(v => v.frequency.toNote());
                const notesToStop = currentlyPlaying.filter(n => !remoteActiveNotes.includes(n));
                const notesToStart = remoteActiveNotes.filter(n => !remoteActiveNotes.includes(n));

                if (notesToStop.length > 0) mainSynth.triggerRelease(notesToStop, Tone.now());
                if (notesToStart.length > 0) mainSynth.triggerAttack(notesToStart, Tone.now());
            });
            window.addEventListener('beforeunload', async () => {
                if (myActivePad) {
                    const padRef = doc(db, `artifacts/${appId}/public/data/elevo-company/${currentSessionId}/pads/${myActivePad.id}`);
                    await deleteDoc(padRef);
                }
                unsubscribeFromPads();
            });
        }
    </script>
</body>
</html>
